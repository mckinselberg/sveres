<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" >-->

    <title>Sveres</title>
    <meta name="description" content="An interactive animation of bouncing spheres." />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script>
    <style></style>
  </head>

  <body>
    <!-- Intro overlay: shown on first load and then at most once per week -->
    <div id="introOverlay" aria-hidden="true">
      <div class="intro-card" role="dialog" aria-modal="true" aria-labelledby="introTitle">
        <h3 id="introTitle">Welcome to Sveres</h3>
        <p>Quick tips to get you started:</p>
        <ul>
          <li>Click or tap the gear to show/hide controls (or press C).</li>
          <li>Drag on a ball to move it; use WASD or arrow keys to nudge the selected ball.</li>
          <li>Use the sliders to change size, speed, gravity, and more. Try Deformation for squishy fun.</li>
          <li>On mobile, panels become bottom sheets and inputs are touch-friendly.</li>
        </ul>
        <div class="actions">
          <button id="introDismiss">Got it</button>
        </div>
      </div>
    </div>
    <div id="controls">
      <h3>Sveres</h3>
      <div class="subdued">Press C or click the gear to toggle this panel.</div>
      <div class="row" style="font-size: 1.1em">Global Score: <span id="globalScoreDisplay">0</span></div>

      <details id="section-simulation" open>
        <summary>Simulation</summary>
        <div class="section-body">
          <div class="row">
            <label for="bounceSpeed">Animation Speed:</label>
            <input type="range" id="bounceSpeed" min="0.5" max="3.0" step="0.1" value="1.0" />
            <span id="speedValue">1.0x</span>
          </div>
          <div class="row">
            <label for="enableGravity">Enable Gravity:</label>
            <input type="checkbox" id="enableGravity" />
          </div>
          <div class="row">
            <label for="gravityStrength">Gravity Strength:</label>
            <input type="range" id="gravityStrength" min="0.1" max="2.0" step="0.1" value="0.5" />
            <span id="gravityValue">0.5</span>
          </div>
          <div class="row">
            <label for="ballVelocity">Ball Velocity:</label>
            <input type="range" id="ballVelocity" min="1" max="15" step="1" value="7" />
            <span id="ballVelocityValue">7</span>
          </div>
        </div>
      </details>

      <details id="section-objects" open>
        <summary>Objects</summary>
        <div class="section-body">
          <div class="row">
            <label for="ballShape">Ball Shape:</label>
            <select id="ballShape">
              <option value="circle">Circle</option>
              <option value="square">Square</option>
              <option value="triangle">Triangle</option>
              <option value="diamond">Diamond</option>
              <option value="pentagon">Pentagon</option>
              <option value="hexagon">Hexagon</option>
              <option value="octagon">Octagon</option>
              <option value="star">Star</option>
              <option value="mixed">Mixed Shapes</option>
            </select>
          </div>
          <div class="row">
            <label for="ballSize">Ball Size:</label>
            <input type="range" id="ballSize" min="10" max="150" step="5" value="45" />
            <span id="ballSizeValue">45px</span>
          </div>
          <!-- <div class="row">
            <label for="ballCount">Number of Balls:</label>
            <input type="range" id="ballCount" min="0" max="200" step="1" value="10" style="width: 150px" />
            <span id="ballCountValue">5</span>
          </div> -->
          <div class="row">
            <button
              id="addBall"
              style="
                background: #4caf50;
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 4px;
                cursor: pointer;
                margin-right: 8px;
              ">
              Add Ball
            </button>
            <button
              id="removeBall"
              style="
                background: #f44336;
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 4px;
                cursor: pointer;
                margin-right: 8px;
              ">
              Remove Ball
            </button>
            <button
              id="resetBalls"
              style="
                background: #2196f3;
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 4px;
                cursor: pointer;
              ">
              Reset
            </button>
          </div>
        </div>
      </details>

      <details id="section-deformation">
        <summary>Deformation</summary>
        <div class="section-body">
          <div class="row">
            <label for="enableDeformation">Enable Realistic Deformation:</label>
            <input type="checkbox" id="enableDeformation" checked />
          </div>
          <div class="row">
            <label for="deformationIntensity">Deformation Intensity:</label>
            <input type="range" id="deformationIntensity" min="0.1" max="1.5" step="0.1" value="0.4" />
            <span id="deformationIntensityValue">0.4</span>
          </div>
          <div class="row">
            <label for="deformationSpeed">Deformation Speed:</label>
            <input type="range" id="deformationSpeed" min="0.01" max="0.1" step="0.01" value="0.04" />
            <span id="deformationSpeedValue">0.04</span>
          </div>
          <div class="row">
            <label for="deformationEase">Deformation Ease:</label>
            <select id="deformationEase">
              <option value="elastic.out(1.1, 0.5)">Elastic</option>
              <option value="bounce.out">Bounce</option>
              <option value="power2.out">Smooth</option>
              <option value="back.out(1.7)">Overshoot</option>
              <option value="slow(0.7, 0.7, false)">Slow Mo</option>
              <option value="steps(12)">Stepped</option>
              <option value="circ.out">Circular</option>
              <option value="expo.out">Exponential</option>
            </select>
          </div>
          <div class="row">
            <label for="deformationEaseOverride">Ease Override:</label>
            <input type="text" id="deformationEaseOverride" placeholder="e.g., elastic.out(1, 0.3)" />
          </div>
        </div>
      </details>

      <details id="section-visuals">
        <summary>Visuals</summary>
        <div class="section-body">
          <div class="row">
            <label for="backgroundColor">Background Color:</label>
            <input type="color" id="backgroundColor" value="#000000" />
          </div>
          <div class="row">
            <label for="trailOpacity">Trail Opacity:</label>
            <input type="range" id="trailOpacity" min="0" max="1" step="0.05" value="0.2" />
            <span id="trailOpacityValue">1.0</span>
          </div>
          <div class="row">
            <label for="uiOpacity">UI Opacity:</label>
            <input type="range" id="uiOpacity" min="0.1" max="1" step="0.05" value="0.8" />
            <span id="uiOpacityValue">0.8</span>
          </div>
        </div>
      </details>

      <details id="section-gameplay">
        <summary>Gameplay</summary>
        <div class="section-body">
          <div class="row">
            <label for="enableScoring">Enable Scoring:</label>
            <input type="checkbox" id="enableScoring" checked />
          </div>
          <div class="row">
            <label for="sandboxMode">Sandbox Mode (No Ball Removal):</label>
            <input type="checkbox" id="sandboxMode" />
          </div>
          <div class="row">
            <label for="enableHealthSystem">Enable Health System:</label>
            <input type="checkbox" id="enableHealthSystem" checked />
          </div>
          <div class="row">
            <label for="healthDamageMultiplier">Health Damage Multiplier:</label>
            <input type="range" id="healthDamageMultiplier" min="0.01" max="1.0" step="0.01" value="0.1" />
            <span id="healthDamageMultiplierValue">0.1</span>
          </div>
        </div>
      </details>

      <details id="section-presets">
        <summary>Presets</summary>
        <div class="section-body">
          <div id="color-scheme-manager" style="margin-bottom: 15px">
            <div class="row" style="font-weight: 600; margin-bottom: 6px">Color Schemes</div>
            <div class="row">
              <input type="text" id="schemeName" placeholder="Scheme Name" />
              <button id="saveScheme" style="margin-left: 10px">Save</button>
            </div>
            <div class="row">
              <select id="schemeSelect"></select>
              <button id="loadScheme" style="margin-left: 10px">Load</button>
              <button id="deleteScheme" style="margin-left: 10px">Delete</button>
            </div>
          </div>

          <div id="physics-settings-manager">
            <div class="row" style="font-weight: 600; margin-bottom: 6px">Physics Settings</div>
            <div class="row">
              <input type="text" id="physicsSchemeName" placeholder="Physics Scheme Name" style="margin-right: 10px" />
              <button id="savePhysicsSettings">Save</button>
            </div>
            <div class="row">
              <select id="physicsSchemeSelect"></select>
              <button id="loadPhysicsSettings" style="margin-left: 10px">Load</button>
              <button id="deletePhysicsSettings" style="margin-left: 10px">Delete</button>
            </div>
          </div>
        </div>
      </details>
    </div>

    <div id="selectedBallControls">
      <h3 id="selectedBallControlsHeader">Selected Ball</h3>

      <details id="section-selected-appearance" open>
        <summary>Appearance</summary>
        <div class="section-body">
          <div class="row">
            <label for="selectedBallColor">Color:</label>
            <input type="color" id="selectedBallColor" value="#ffffff" />
          </div>
          <div class="row">
            <label for="selectedBallShape">Shape:</label>
            <select id="selectedBallShape">
              <option value="circle">Circle</option>
              <option value="square">Square</option>
              <option value="triangle">Triangle</option>
              <option value="diamond">Diamond</option>
              <option value="pentagon">Pentagon</option>
              <option value="hexagon">Hexagon</option>
              <option value="octagon">Octagon</option>
              <option value="star">Star</option>
            </select>
          </div>
          <div class="row">
            <label for="selectedBallSize">Size:</label>
            <input type="range" id="selectedBallSize" min="10" max="150" step="5" value="45" />
            <span id="selectedBallSizeValue">45px</span>
          </div>
          <div class="row">
            <label for="selectedBallOpacity">Opacity:</label>
            <input type="range" id="selectedBallOpacity" min="0" max="1" step="0.05" value="1" />
            <span id="selectedBallOpacityValue">1</span>
          </div>
        </div>
      </details>

      <details id="section-selected-motion">
        <summary>Motion</summary>
        <div class="section-body">
          <div class="row">
            <label for="selectedBallVelocity">Velocity:</label>
            <input type="range" id="selectedBallVelocity" min="1" max="15" step="1" value="7" />
            <span id="selectedBallVelocityValue">7</span>
          </div>
          <div class="row">
            <label for="selectedBallSpeed">Speed:</label>
            <input type="range" id="selectedBallSpeed" min="0" max="20" step="1" value="7" />
            <span id="selectedBallSpeedValue">7</span>
          </div>
          <div class="row">
            <label for="selectedBallSpeedMultiplier">Speed Multiplier:</label>
            <input type="range" id="selectedBallSpeedMultiplier" min="0.1" max="5" step="0.1" value="1" />
            <span id="selectedBallSpeedMultiplierValue">1x</span>
          </div>
        </div>
      </details>

      <details id="section-selected-stats">
        <summary>Stats</summary>
        <div class="section-body">
          <div class="row">
            <label for="selectedBallCollisionCount">Collision Count:</label>
            <span id="selectedBallCollisionCount">0</span>
          </div>
          <div class="row">
            <label for="selectedBallHealth">Health:</label>
            <span id="selectedBallHealth">100</span>
          </div>
        </div>
      </details>

      <details id="section-selected-actions">
        <summary>Actions</summary>
        <div class="section-body">
          <button
            id="resetSelectedBall"
            style="
              background: #f44336;
              color: white;
              border: none;
              padding: 8px 12px;
              border-radius: 4px;
              cursor: pointer;
              margin-right: 8px;
            ">
            Reset Selected Ball
          </button>
          <button
            id="saveBall"
            style="
              background: #4caf50;
              color: white;
              border: none;
              padding: 8px 12px;
              border-radius: 4px;
              cursor: pointer;
            ">
            Save Ball
          </button>
        </div>
      </details>

      <details id="section-selected-saved-balls">
        <summary>Saved Balls</summary>
        <div class="section-body" id="saved-balls-manager">
          <div class="row">
            <select id="savedBallsSelect"></select>
            <button id="loadBall" style="margin-left: 10px">Load</button>
            <button id="deleteBall" style="margin-left: 10px">Delete</button>
          </div>
        </div>
      </details>
    </div>

    <!-- Toggle button for control panel visibility -->
    <button id="toggleControls" title="Show Controls">⚙️</button>

    <div class="container">
      <canvas id="canvas"></canvas>
    </div>
    <script type="module" src="/src/index.js"></script>
    <script>
      // Intro overlay show/hide with 1-week re-show window
      (function () {
        try {
          const overlay = document.getElementById("introOverlay");
          const dismissBtn = document.getElementById("introDismiss");
          const STORAGE_KEY = "introOverlay:lastDismissedAt";
          const WEEK_MS = 7 * 24 * 60 * 60 * 1000;
          const now = Date.now();
          const last = parseInt(localStorage.getItem(STORAGE_KEY) || "0", 10);
          const shouldShow = !last || now - last > WEEK_MS;

          if (overlay && shouldShow) {
            overlay.style.display = "flex";
            overlay.setAttribute("aria-hidden", "false");
          }

          if (dismissBtn) {
            const dismiss = () => {
              if (!overlay) return;
              overlay.style.display = "none";
              overlay.setAttribute("aria-hidden", "true");
              try {
                localStorage.setItem(STORAGE_KEY, String(Date.now()));
              } catch (e) {
                /* noop */
              }
            };
            dismissBtn.addEventListener("click", dismiss);
            // Allow clicking backdrop to dismiss
            overlay &&
              overlay.addEventListener("click", (e) => {
                if (e.target === overlay) dismiss();
              });
          }
        } catch (e) {
          // Fail open: never block the app
        }
      })();

      // Draggable functionality for selectedBallControls with position persistence
      const selectedBallControls = document.getElementById("selectedBallControls");
      const header = document.getElementById("selectedBallControlsHeader");

      let isDragging = false;
      let offsetX, offsetY;

      // Load saved position from localStorage
      const savedPosition = JSON.parse(localStorage.getItem("selectedBallControlsPosition"));
      if (savedPosition) {
        selectedBallControls.style.left = savedPosition.left;
        selectedBallControls.style.top = savedPosition.top;
      }

      // Enable drag on desktop only; keep fixed position on mobile
      const enableDrag = window.matchMedia ? !window.matchMedia("(max-width: 768px)").matches : window.innerWidth > 768;
      if (enableDrag) {
        header.addEventListener("mousedown", (e) => {
          isDragging = true;
          offsetX = e.clientX - selectedBallControls.offsetLeft;
          offsetY = e.clientY - selectedBallControls.offsetTop;
          header.style.cursor = "grabbing";
        });

        document.addEventListener("mousemove", (e) => {
          if (isDragging) {
            const left = `${e.clientX - offsetX}px`;
            const top = `${e.clientY - offsetY}px`;
            selectedBallControls.style.left = left;
            selectedBallControls.style.top = top;
          }
        });

        document.addEventListener("mouseup", () => {
          if (isDragging) {
            isDragging = false;
            header.style.cursor = "grab";

            // Save position to localStorage
            const position = {
              left: selectedBallControls.style.left,
              top: selectedBallControls.style.top,
            };
            localStorage.setItem("selectedBallControlsPosition", JSON.stringify(position));
          }
        });
      }

      // Persist open/closed state of details sections
      const sectionKeys = [
        "section-simulation",
        "section-objects",
        "section-deformation",
        "section-visuals",
        "section-gameplay",
        "section-presets",
        "section-selected-appearance",
        "section-selected-motion",
        "section-selected-stats",
        "section-selected-actions",
        "section-selected-saved-balls",
      ];
      sectionKeys.forEach((id) => {
        const el = document.getElementById(id);
        if (!el) return;
        const saved = localStorage.getItem(`details:${id}`);
        if (saved !== null) {
          if (saved === "open") el.setAttribute("open", "");
          else el.removeAttribute("open");
        }
        el.addEventListener("toggle", () => {
          localStorage.setItem(`details:${id}`, el.open ? "open" : "closed");
        });
      });
    </script>
  </body>
</html>
